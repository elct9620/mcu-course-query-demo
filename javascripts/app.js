(function(){var e,r,t,n,o,u,c,s,a,l,i;i=function(e,r,t,n,o){return t.length-1>r?t[r+1].match(/(INSERT|CREATE|DROP|PRAGMA|BEGIN|COMMIT)/)?e.transaction(function(u){return u.executeSql(t[r]+";",[],function(){return i(e,r+1,t,n,o)})},function(u){return console.log("Query error in ",t[r],u.message),i(e,r+1,t,n,o)}):(t[r+1]=t[r]+";\n"+t[r+1],i(e,r+1,t,n,o)):("function"==typeof o&&o(),console.log("Done importing!"))},l=function(e){return e.transaction(function(e){return e.executeSql("select 'drop table ' || name || ';' as cmd from sqlite_master where type = 'table';",[],function(e,r){var t,n,o,u,c,s,a;for(s=r.rows,a=[],n=u=0,c=s.length;c>u;n=++u)o=s[n],t=r.rows.item(n).cmd,a.push(e.executeSql(t,[],function(){return t=null},function(e,r){return console.log(r.message)}));return a})})},o=!1,window.openDatabase&&(n=openDatabase("mcu","1.0","MCU Course Database",1048576),o&&l(n,"mcu")),u={1:"通識",2:"必修",3:"選修",4:"教育"},s={1:"大學日間部",2:"碩士班",3:"海青班",4:"研碩士班",5:"博士班",6:"碩士專班"},c={1:"上學期",2:"下學期",3:"全學期"},a={0:"不區分",1:"一年級",2:"二年級",3:"三年級",4:"四年級",5:"五年級"},r={0:"",1:"星期一",2:"星期二",3:"星期三",4:"星期四",5:"星期五",6:"星期六"},t=["01","02","03","04","20","05","06","07","08","09","30","40","50","60","70"],e=angular.module("CourseQuery",["ngRoute"]),e.controller("CourseController",["$scope",function(e){return e.page=1,e.perPage=25,e.maxPage=1,e.course_query="",e.course_code_query="",e.courses=[],e.formatSelectType=function(e){return u[e]},e.formatSystem=function(e){return s[e]},e.formatSemester=function(e){return c[e]},e.formatYear=function(e){return a[e]},e.getCourses=function(r){var t,n;return t=e.page||1,e.perPage=r,e.maxPage=Math.ceil(e.courses.length/r),n=e.courses.slice((t-1)*r,t*r)},e.getRepeat=function(e){return new Array(e)},e.changePage=function(r){return e.page=r},e.update=function(){var r,t;return e.page=1,e.maxPage=1,e.courses=[],0>=e.course_query.length&&0>=e.course_code_query.length?void 0:(t=[],e.course_query.length>0&&t.push("course_name LIKE '%"+e.course_query+"%'"),e.course_code_query.length>0&&t.push("course_code LIKE '%"+e.course_code_query+"%'"),r=t.join(" AND "),n.transaction(function(t){return t.executeSql("SELECT * FROM courses WHERE "+r+";",[],function(r,t){var n,o,u,c,s,a,l;for(a=t.rows,l=[],o=c=0,s=a.length;s>c;o=++c)u=a[o],n=t.rows.item(o),e.courses.push({system:n.system,select_type:n.select_type,code:n.course_code,class_code:n.class_code,name:n.course_name,selected_people:n.selected_people,max_people:n.max_people,credit:n.credit,year:n.year,semester:n.semester}),l.push(e.$apply());return l},function(e,r){return console.log("Error: "+r.message)})}))}}]),e.controller("CalendarController",["$scope",function(e){var o,l;for(e.courseTable=new Array(6),e.vex="Hi",e.selecting=!1,e.currentX=0,e.currentY=0,e.page=1,e.perPage=25,e.maxPage=1,e.courses=[],e.formatSelectType=function(e){return u[e]},e.formatSystem=function(e){return s[e]},e.formatSemester=function(e){return c[e]},e.formatYear=function(e){return a[e]},o=l=0;5>=l;o=++l)e.courseTable[o]=new Array(14);return e.getRepeat=function(e){return new Array(e)},e.getCourseDay=function(e){return r[e]},e.getCourseTime=function(e){return t[e]},e.selectCourse=function(r,t){return e.selecting=!0,e.currentX=r,e.currentY=t,e.updateCourseList(r,t)},e.activeCourse=function(r){var t,n,o,u;return n=r+(e.page-1)*e.perPage,t=e.courses[n],o=e.currentX,u=e.currentY,e.courseTable[o][u]={name:t.name,class_code:t.class_code},e.selecting=!1},e.changePage=function(r){return e.page=r},e.updateCourseList=function(r,u){var c,s;return e.page=1,e.maxPage=1,e.courses=[],c=[],c.push("courses.id = teachers.course_id"),c.push("teachers.id = course_times.teacher_id"),c.push("teachers.course_day = "+r),c.push("course_times.time = "+t[u]),s=c.join(" AND "),n.transaction(function(r){return r.executeSql("SELECT * FROM courses JOIN teachers LEFT JOIN course_times WHERE "+s+";",[],function(r,t){var n,u,c,s,a,l;for(a=t.rows,l=[],o=c=0,s=a.length;s>c;o=++c)u=a[o],n=t.rows.item(o),e.courses.push({system:n.system,select_type:n.select_type,code:n.course_code,class_code:n.class_code,name:n.course_name,selected_people:n.selected_people,max_people:n.max_people,credit:n.credit,year:n.year,semester:n.semester}),l.push(e.$apply());return l},function(e,r){return console.log("Error: "+r.message)})})},e.getCourseData=function(r,t){return e.courseTable[r]&&e.courseTable[r][t]?e.courseTable[r][t]:{name:"尚未選課",class_code:"000000"}},e.getCourses=function(r){var t,n;return t=e.page||1,e.perPage=r,e.maxPage=Math.ceil(e.courses.length/r),n=e.courses.slice((t-1)*r,t*r)}}]),e.controller("Navigation",["$scope","$route",function(e,r){return e.ready=!1,e.error=!1,e.loadingMessage="讀取課程資料中⋯⋯",$.get("mcu.sql",function(r){return window.openDatabase?o?i(n,2,r.split(";\n"),"mcu",function(){return e.ready=!0,e.$apply()}):(e.ready=!0,e.$apply()):(e.error=!0,e.loadingMessage="因為支援問題無法取得資料庫，建議使用 Chrome 讀取（將會在未來被修正）",e.$apply())}),e.updateDatabase=function(){return e.error?void 0:(e.ready=!1,l(n,"mcu"),$.get("mcu.sql",function(r){return i(n,2,r.split(";\n"),"mcu",function(){return e.ready=!0,e.$apply()})}))},e.isCurrent=function(e){return r.current&&r.current.$$route&&r.current.$$route.controller===e?!0:!1}}]),e.config(["$routeProvider","$locationProvider",function(e,r){return e.when("/",{templateUrl:"partials/default.html",controller:"CourseController"}).when("/calendar",{templateUrl:"partials/calendar.html",controller:"CalendarController"}).otherwise({redirectTo:"/"}),r.html5Mode(!0)}])}).call(this);